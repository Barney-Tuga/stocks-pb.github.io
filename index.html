<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificador de Stocks</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
            overflow: hidden;
        }
        
        header {
            background: #2196F3;
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            z-index: 10;
        }
        
        header h1 {
            font-size: 1.5rem;
            font-weight: 500;
        }
        
        .content-wrapper {
            height: calc(100vh - 120px);
            overflow-y: auto;
            padding: 15px;
        }
        
        .button-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .check-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex: 1;
            max-width: 160px;
        }
        
        .check-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .check-button.primary {
            background: #2196F3;
        }
        
        .check-button.primary:hover {
            background: #1E88E5;
        }
        
        .check-button.success {
            background: #4CAF50;
        }
        
        .check-button.success:hover {
            background: #43A047;
        }
        
        .check-button.warning {
            background: #FF9800;
        }
        
        .check-button.warning:hover {
            background: #F57C00;
        }
        
        .check-button i {
            font-size: 1.5rem;
        }
        
        .stats-section {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            gap: 10px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            flex: 1;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #757575;
            font-size: 0.8rem;
        }
        
        .pending-section {
            margin-top: 20px;
            text-align: left;
        }
        
        .section-title {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2196F3;
            color: #333;
            font-size: 1.1rem;
        }
        
        .pending-list, .notes-list, .tasks-list {
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        
        .pending-item, .note-item, .task-item {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .item-info {
            flex: 1;
        }
        
        .item-ref {
            font-weight: bold;
            color: #333;
        }
        
        .item-details {
            margin-top: 5px;
            font-size: 0.8rem;
            color: #757575;
        }
        
        .item-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 5px;
        }
        
        .action-btn.edit {
            color: #2196F3;
        }
        
        .action-btn.delete {
            color: #F44336;
        }
        
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #9E9E9E;
        }
        
        /* Footer Menu */
        .footer-menu {
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px;
            position: fixed;
            bottom: 0;
            width: 100%;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        
        .menu-btn {
            background: none;
            border: none;
            color: #9E9E9E;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            transition: color 0.3s;
            padding: 5px;
        }
        
        .menu-btn.active {
            color: #2196F3;
        }
        
        .menu-btn i {
            font-size: 1.2rem;
        }
        
        /* History View */
        .history-view, .notes-view, .tasks-view, .settings-view {
            display: none;
            padding: 15px;
            overflow-y: auto;
        }
        
        .search-bar {
            display: flex;
            margin-bottom: 15px;
        }
        
        .search-bar input {
            border-radius: 8px 0 0 8px;
            flex: 1;
            border: 1px solid #e0e0e0;
            padding: 10px;
            font-size: 14px;
        }
        
        .search-bar button {
            border-radius: 0 8px 8px 0;
            background: #2196F3;
            color: white;
            border: none;
            padding: 0 15px;
            cursor: pointer;
        }
        
        .filter-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .filter-btn, .checklist-btn, .remove-mode-btn, .clear-filter-btn {
            padding: 10px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            flex: 1;
            font-size: 0.9rem;
        }
        
        .filter-btn {
            background: #2196F3;
        }
        
        .checklist-btn {
            background: #4CAF50;
        }
        
        .remove-mode-btn {
            background: #F44336;
        }
        
        .clear-filter-btn {
            background: #9E9E9E;
        }
        
        .history-list, .notes-list, .tasks-list {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        
        .history-item {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .history-ref {
            font-weight: bold;
            color: #333;
        }
        
        .history-date {
            color: #757575;
            font-size: 0.8rem;
        }
        
        .history-details {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .history-quantity {
            font-weight: 600;
            text-align: left;
            font-size: 0.9rem;
        }
        
        .history-difference {
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .positive {
            background-color: #E8F5E9;
            color: #2E7D32;
        }
        
        .negative {
            background-color: #FFEBEE;
            color: #C62828;
        }
        
        .neutral {
            background-color: #E3F2FD;
            color: #1565C0;
        }
        
        .history-notes {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #e0e0e0;
            color: #757575;
            font-style: italic;
            font-size: 0.9rem;
        }
        
        /* Checkbox styling */
        .history-checkbox {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Remove button in history items */
        .history-remove-btn {
            background: #F44336;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 8px;
            cursor: pointer;
            margin-left: 8px;
            display: none;
            font-size: 0.8rem;
        }
        
        /* Selected item style */
        .history-item.selected {
            background-color: #E3F2FD;
        }
        
        .history-item.selected .history-ref {
            color: #1565C0;
        }
        
        /* Notes specific styles */
        .note-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .note-date {
            color: #757575;
            font-size: 0.8rem;
        }

        .note-type {
            color: #2196F3;
            font-size: 0.8rem;
            margin-top: 3px;
        }
        
        /* Task specific styles */
        .task-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .task-description {
            color: #757575;
            font-size: 0.8rem;
        }
        
        .task-date {
            color: #757575;
            font-size: 0.7rem;
            margin-top: 5px;
        }
        
        /* Settings specific styles */
        .settings-category {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .settings-category h3 {
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .note-type-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: grab;
            user-select: none;
            touch-action: none; /* allow Pointer Events dragging on mobile */
            transition: background-color 0.2s;
        }
        
        .note-type-item:active {
            cursor: grabbing;
        }
        
        .note-type-item.dragging {
            opacity: 0.7;
            background-color: #e3f2fd;
        }
        
        .drag-handle {
            margin-right: 10px;
            color: #757575;
            cursor: grab;
            display: flex;
            flex-direction: column;
            touch-action: none;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }

        /* Placeholder visual while dragging (created dynamically) */
        .note-type-item.placeholder {
            opacity: 0.95;
            background: rgba(0,0,0,0.04) !important;
            border: 2px dashed #d0d0d0 !important;
        }

        /* Class used to enable a smooth release animation */
        .note-type-item.release-anim {
            transition: transform 180ms ease, opacity 180ms ease;
        }
        
        .note-type-name {
            font-weight: 500;
            flex: 1;
        }
        
        .add-type-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
        }
        
        .modal-title {
            font-size: 1.3rem;
            color: #333;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #757575;
            position: absolute;
            top: 0;
            right: 0;
        }
        
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        /* Force visual uppercase for item reference input */
        #itemReference {
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .modal-actions {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-top: 15px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .btn-success:hover {
            background: #43A047;
        }
        
        .btn-waiting {
            background: #2196F3;
            color: white;
        }
        
        .btn-waiting:hover {
            background: #1E88E5;
        }
        
        .btn-danger {
            background: #F44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #E53935;
        }
        
        /* Lotes styles */
        .lotes-checkbox {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 8px;
            margin: 15px 0;
        }

        .lotes-checkbox input[type="checkbox"] {
            margin: 0;
            width: auto;
        }

        .lotes-checkbox label {
            margin: 0;
            font-weight: 600;
            color: #333;
            order: 2;
        }

        .lotes-container {
            display: none;
            margin-top: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
        }
        
        .lote-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
        }
        
        .lote-name-container {
            flex: 1;
        }
        
        .lote-name-container input {
            margin-bottom: 0;
        }
        
        .lote-toggle {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #757575;
            padding: 5px;
            margin-left: 8px;
        }
        
        .lote-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }
        
        .lote-details.collapsed {
            display: none;
        }
        
        .lote-quantities {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .add-lote-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
            font-size: 0.9rem;
        }
        
        .remove-lote-btn {
            background: #F44336;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px;
            cursor: pointer;
            align-self: center;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s, top 0.3s;
        }
        
        .notification.show {
            opacity: 1;
            top: 30px;
        }

        .notification-action {
            background: rgba(255,255,255,0.12);
            color: white;
            border: none;
            padding: 6px 10px;
            margin-left: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Scanner overlay */
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scanner-target {
            width: 70%;
            max-width: 420px;
            height: 40%;
            border: 2px dashed rgba(255,255,255,0.8);
            box-shadow: 0 0 0 2000px rgba(0,0,0,0.25);
            border-radius: 8px;
        }
        
        /* Table styles for lotes in history */
        .lotes-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 0.8rem;
        }
        
        .lotes-table th, .lotes-table td {
            padding: 6px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .lotes-table th {
            background-color: #f5f5f5;
            font-weight: 600;
        }
        
        .lotes-table .positive {
            background-color: #E8F5E9;
            color: #2E7D32;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .lotes-table .negative {
            background-color: #FFEBEE;
            color: #C62828;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        /* Filter Modal Styles */
        .filter-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .filter-modal-content {
            background: white;
            border-radius: 12px;
            padding: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .date-inputs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .date-input {
            flex: 1;
        }
        
        .date-input label {
            font-size: 0.8rem;
            margin-bottom: 5px;
            display: block;
        }
        
        .date-input input {
            padding: 8px;
            font-size: 14px;
        }
        
        .filter-type {
            margin-bottom: 15px;
        }
        
        .filter-type label {
            font-size: 0.8rem;
            margin-bottom: 5px;
            display: block;
        }
        
        .filter-type select {
            padding: 8px;
            font-size: 14px;
        }
        
        .filter-modal-actions {
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }
        
        .filter-modal-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .apply-filter-btn {
            background: #4CAF50;
            color: white;
        }
        
        .apply-filter-btn:hover {
            background: #43A047;
        }
        
        .cancel-filter-btn {
            background: #9E9E9E;
            color: white;
        }
        
        .cancel-filter-btn:hover {
            background: #757575;
        }
        
        /* Confirmation Modals */
        .confirmation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .confirmation-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        
        .confirmation-message {
            margin-bottom: 20px;
            font-size: 1rem;
        }
        
        .confirmation-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .confirmation-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .confirm-btn {
            background: #F44336;
            color: white;
        }
        
        .cancel-btn {
            background: #9E9E9E;
            color: white;
        }
        
        @media (max-width: 768px) {
            .button-row {
                flex-direction: column;
                align-items: center;
            }
            
            .check-button {
                width: 100%;
                max-width: 100%;
            }
            
            .stats-section {
                flex-direction: column;
            }
            
            .filter-actions {
                flex-direction: row;
            }
            
            .date-inputs {
                flex-direction: column;
            }
            
            .lote-details {
                grid-template-columns: 1fr;
            }
            
            .history-header, .history-details {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .notification {
                top: 15px;
                width: 90%;
                text-align: center;
                font-size: 0.9rem;
            }
            
            .notification.show {
                top: 25px;
            }
        }
    </style>
</head>
<body>
    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationMessage"></span>
        <button id="notificationAction" class="notification-action" style="display:none"></button>
    </div>

    <header>
        <h1>Verificador de Stocks</h1>
    </header>
    
    <!-- Home View -->
    <div class="content-wrapper">
        <div class="main-content" id="home-view">
            <div class="button-row">
                <button class="check-button primary" id="checkItemBtn">
                    <i class="fas fa-clipboard-check"></i>
                    Verificar Item
                </button>
                <button class="check-button success" id="addNoteBtn">
                    <i class="fas fa-plus"></i>
                    Adicionar Nota
                </button>
                <button class="check-button warning" id="addTaskBtn">
                    <i class="fas fa-plus"></i>
                    Adicionar Tarefa
                </button>
            </div>
            
            <div class="pending-section">
                <h2 class="section-title">Verificações em Espera</h2>
                <div class="pending-list" id="pendingList">
                    <div class="empty-state">
                        <i class="fas fa-clock" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <p>Nenhuma verificação em espera</p>
                    </div>
                </div>
            </div>
            
            <div class="pending-section">
                <h2 class="section-title">Estatísticas</h2>
                <div class="stats-section">
                    <div class="stat-card">
                        <div class="stat-value" id="completedCount">0</div>
                        <div class="stat-label">Concluídas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pendingCount">0</div>
                        <div class="stat-label">Em Espera</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="notesCount">0</div>
                        <div class="stat-label">Notas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="tasksCount">0</div>
                        <div class="stat-label">Tarefas</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- History View -->
        <div class="history-view" id="history-view">
            <h2 class="section-title">Histórico de Verificações</h2>
            
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Pesquisar por referência...">
                <button id="searchBtn"><i class="fas fa-search"></i></button>
            </div>
            
            <div class="filter-actions">
                <button class="filter-btn" id="filterBtn">
                    <i class="fas fa-filter"></i> 
                </button>
                <button class="checklist-btn" id="checklistBtn">
                    <i class="fas fa-check-square"></i> 
                </button>
                <button class="remove-mode-btn" id="removeModeBtn">
                    <i class="fas fa-times"></i> 
                </button>
                <button class="clear-filter-btn" id="clearFilterBtn">
                    <i class="fas fa-eraser"></i> 
                </button>
            </div>
            
            <div class="history-list" id="historyList">
                <div class="empty-state">
                    <i class="fas fa-history" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                    <p>Nenhuma verificação no histórico</p>
                </div>
            </div>
        </div>
        
        <!-- Notes View -->
        <div class="notes-view" id="notes-view">
            <h2 class="section-title">Anotações</h2>
            
            <!-- Barra de pesquisa para anotações -->
            <div class="search-bar">
                <input type="text" id="notesSearchInput" placeholder="Pesquisar por título...">
                <button id="notesSearchBtn"><i class="fas fa-search"></i></button>
            </div>
            
            <!-- Botões de filtro para anotações -->
            <div class="filter-actions">
                <button class="filter-btn" id="notesFilterBtn">
                    <i class="fas fa-filter"></i> Filtrar
                </button>
            </div>
            
            <div class="notes-list" id="notesList">
                <div class="empty-state">
                    <i class="fas fa-sticky-note" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                    <p>Nenhuma anotação</p>
                </div>
            </div>
        </div>
        
        <!-- Tasks View -->
        <div class="tasks-view" id="tasks-view">
            <h2 class="section-title">Tarefas</h2>
            
            <div class="tasks-list" id="tasksList">
                <div class="empty-state">
                    <i class="fas fa-tasks" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                    <p>Nenhuma tarefa</p>
                </div>
            </div>
        </div>
        
        <!-- Settings View -->
        <div class="settings-view" id="settings-view">
            <h2 class="section-title">Definições</h2>
            
            <div class="settings-category">
                <h3>Perfil</h3>
                <div class="form-group">
                    <label for="userName">Nome</label>
                    <input type="text" id="userName" placeholder="Seu nome">
                </div>
            </div>
            
            <div class="settings-category">
                <h3>Outros</h3>
                <div class="settings-option" id="noteTypesOption">
                    <h4>Tipo de Nota</h4>
                    <div class="note-types-list" id="noteTypesList">
                        <!-- Lista de tipos de nota será preenchida via JavaScript -->
                    </div>
                    <button class="add-type-btn" id="addNoteTypeBtn">
                        <i class="fas fa-plus"></i> Adicionar Tipo de Nota
                    </button>
                </div>
            </div>
            
            <div class="settings-category">
                <h3>Backup & Ferramentas</h3>
                <div class="settings-option" id="backupTools">
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="add-type-btn" id="exportDataBtn"><i class="fas fa-download"></i> Exportar JSON</button>
                        <button class="add-type-btn" id="importDataBtn"><i class="fas fa-upload"></i> Importar JSON</button>
                        <input type="file" id="importFileInput" accept="application/json" style="display:none" />
                        <button class="add-type-btn" id="scannerBtn"><i class="fas fa-qrcode"></i> Scanner (QR / Barcode)</button>
                        <button class="add-type-btn" id="shareReportBtn"><i class="fas fa-share-alt"></i> Partilhar Relatório</button>
                        <button class="add-type-btn" id="exportPdfBtn"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer Menu -->
    <div class="footer-menu">
        <button class="menu-btn active" id="homeBtn">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </button>
        <button class="menu-btn" id="historyBtn">
            <i class="fas fa-clipboard-list"></i>
            <span>Histórico</span>
        </button>
        <button class="menu-btn" id="notesBtn">
            <i class="fas fa-sticky-note"></i>
            <span>Anotações</span>
        </button>
        <button class="menu-btn" id="tasksBtn">
            <i class="fas fa-tasks"></i>
            <span>Tarefas</span>
        </button>
        <button class="menu-btn" id="settingsBtn">
            <i class="fas fa-cog"></i>
            <span>Definições</span>
        </button>
    </div>
    
    <!-- Verification Modal -->
    <div class="modal" id="verificationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Verificar Item</h2>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="itemReference">Referência do Artigo</label>
                <div style="display:flex;gap:8px;align-items:center;">
                    <input type="text" id="itemReference" placeholder="Ex: REF-12345" style="flex:1">
                    <button id="openScannerFromVerifyBtn" class="add-type-btn" style="padding:8px 10px;font-size:0.9rem;"> <i class="fas fa-qrcode"></i> Scanner</button>
                </div>
            </div>
            
            <div class="lotes-checkbox">
                <input type="checkbox" id="hasLotes">
                <label for="hasLotes">Lotes</label>
            </div>
            
            <div class="lotes-container" id="lotesContainer">
                <div class="lote-item">
                    <div class="lote-header">
                        <div class="lote-name-container">
                            <input type="text" placeholder="Nome do Lote" class="lote-name">
                        </div>
                        <button class="lote-toggle">−</button>
                    </div>
                    <div class="lote-details">
                        <div class="lote-quantities">
                            <input type="number" placeholder="PC" class="lote-pc">
                        </div>
                        <div class="lote-quantities">
                            <input type="number" placeholder="Stock" class="lote-stock">
                        </div>
                        <button class="remove-lote-btn">&times;</button>
                    </div>
                </div>
                <button class="add-lote-btn" id="addLoteBtn">
                    <i class="fas fa-plus"></i> Adicionar Lote
                </button>
            </div>
            
            <div class="form-group" id="standardQuantities">
                <label for="itemQuantityPc">Quantidade PC</label>
                <input type="number" id="itemQuantityPc" placeholder="Ex: 10">
            </div>
            
            <div class="form-group" id="standardQuantities2">
                <label for="itemQuantityStock">Quantidade Stock</label>
                <input type="number" id="itemQuantityStock" placeholder="Ex: 8">
            </div>
            
            <div class="form-group">
                <label for="itemNotes">Observações</label>
                <textarea id="itemNotes" placeholder="Notas adicionais..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn btn-success" id="saveBtn">
                    <i class="fas fa-check"></i> 
                </button>
                <button class="modal-btn btn-waiting" id="waitBtn">
                    <i class="fas fa-clock"></i> 
                </button>
                <button class="modal-btn btn-danger" id="cancelBtn">
                    <i class="fas fa-times"></i> 
                </button>
            </div>
        </div>
    </div>
    
    <!-- Notes Modal -->
    <div class="modal" id="notesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="notesModalTitle">Nova Anotação</h2>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="noteTitle">Título</label>
                <input type="text" id="noteTitle" placeholder="Título da anotação">
            </div>
            
            <!-- Dropdown para tipo de nota -->
            <div class="form-group">
                <label for="noteType">Tipo de Nota</label>
                <select id="noteType">
                    <!-- Opções serão preenchidas dinamicamente com base na ordem dos noteTypes -->
                </select>
            </div>
            
            <div class="form-group">
                <label for="noteContent">Conteúdo</label>
                <textarea id="noteContent" placeholder="Escreva sua anotação..." rows="5"></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn btn-success" id="saveNoteBtn">
                    <i class="fas fa-save"></i> 
                </button>
                <button class="modal-btn btn-danger" id="deleteNoteBtn">
                    <i class="fas fa-trash"></i> 
                </button>
            </div>
        </div>
    </div>
    
    <!-- Task Modal -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="taskModalTitle">Nova Tarefa</h2>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="taskTitle">Título</label>
                <input type="text" id="taskTitle" placeholder="Título da tarefa">
            </div>
            
            <div class="form-group">
                <label for="taskDescription">Descrição</label>
                <textarea id="taskDescription" placeholder="Descrição da tarefa" rows="5"></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn btn-success" id="saveTaskBtn">
                    <i class="fas fa-save"></i> Guardar
                </button>
                <button class="modal-btn btn-danger" id="deleteTaskBtn" style="display: none;">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Note Type Modal -->
    <div class="modal" id="noteTypeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Adicionar Tipo de Nota</h2>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="newNoteType">Tipo de Nota</label>
                <input type="text" id="newNoteType" placeholder="Ex: Falta Fornecedor">
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn btn-success" id="saveNoteTypeBtn">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div class="modal" id="scannerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Scanner QR / Barcode</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div style="text-align:center;">
                <video id="scannerVideo" autoplay playsinline style="width:100%;max-height:320px;background:#000"></video>
                <p id="scannerMessage">Aponte a câmara para um código.</p>
                <div class="scanner-overlay"><div class="scanner-target"></div></div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-danger" id="stopScannerBtn">Parar Scanner</button>
            </div>
        </div>
    </div>

    <!-- Chooser Modal (for multiple lote matches) -->
    <div class="modal" id="chooserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Escolher Verificação</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div id="chooserList" style="max-height:50vh;overflow:auto;padding:8px"></div>
        </div>
    </div>
    
    <!-- Filter Modal -->
    <div class="filter-modal" id="filterModal">
        <div class="filter-modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Filtrar Verificações</h2>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="date-inputs">
                <div class="form-group date-input">
                    <label for="startDate">Data Início</label>
                    <input type="date" id="startDate" value="2025-01-01">
                </div>
                
                <div class="form-group date-input">
                    <label for="endDate">Data Fim</label>
                    <input type="date" id="endDate">
                </div>
            </div>
            
            <div class="form-group filter-type">
                <label for="filterType">Tipo</label>
                <select id="filterType">
                    <option value="">Todas as verificações</option>
                    <option value="checked">Verificado</option>
                    <option value="unchecked">Não Verificado</option>
                </select>
            </div>
            
            <div class="filter-modal-actions">
                <button class="filter-modal-btn apply-filter-btn" id="applyFilterBtn">Aplicar Filtro</button>
                <!-- Botão de limpar filtro no lugar do cancelar -->
                <button class="filter-modal-btn cancel-filter-btn" id="clearFilterModalBtn">
                    <i class="fas fa-eraser"></i> Limpar Filtro
                </button>
            </div>
        </div>
    </div>
    
    <!-- Filter Modal for Notes -->
    <div class="filter-modal" id="notesFilterModal">
        <div class="filter-modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Filtrar Anotações</h2>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="date-inputs">
                <div class="form-group date-input">
                    <label for="notesStartDate">Data Início</label>
                    <input type="date" id="notesStartDate" value="2025-01-01">
                </div>
                
                <div class="form-group date-input">
                    <label for="notesEndDate">Data Fim</label>
                    <input type="date" id="notesEndDate">
                </div>
            </div>
            
            <div class="form-group filter-type">
                <label for="notesFilterType">Tipo</label>
                <select id="notesFilterType">
                    <!-- Opções serão preenchidas dinamicamente com base na ordem dos noteTypes -->
                </select>
            </div>
            
            <div class="filter-modal-actions">
                <button class="filter-modal-btn apply-filter-btn" id="applyNotesFilterBtn">Aplicar Filtro</button>
                <button class="filter-modal-btn cancel-filter-btn" id="clearNotesFilterBtn">
                    <i class="fas fa-eraser"></i> Limpar Filtro
                </button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modals -->
    <div class="confirmation-modal" id="confirmRemovePendingModal">
        <div class="confirmation-content">
            <h2 class="modal-title">Confirmar Remoção</h2>
            <p class="confirmation-message">Tem a certeza que deseja remover esta verificação em espera?</p>
            <div class="confirmation-actions">
                <button class="confirmation-btn cancel-btn" id="cancelRemovePending">Cancelar</button>
                <button class="confirmation-btn confirm-btn" id="confirmRemovePending">Remover</button>
            </div>
        </div>
    </div>
    
    <div class="confirmation-modal" id="confirmRemoveHistoryModal">
        <div class="confirmation-content">
            <h2 class="modal-title">Confirmar Remoção</h2>
            <p class="confirmation-message">Tem a certeza que deseja remover este item do histórico?</p>
            <div class="confirmation-actions">
                <button class="confirmation-btn cancel-btn" id="cancelRemoveHistory">Cancelar</button>
                <button class="confirmation-btn confirm-btn" id="confirmRemoveHistory">Remover</button>
            </div>
        </div>
    </div>
    
    <div class="confirmation-modal" id="confirmRemoveNoteModal">
        <div class="confirmation-content">
            <h2 class="modal-title">Confirmar Remoção</h2>
            <p class="confirmation-message">Tem a certeza que deseja apagar esta anotação?</p>
            <div class="confirmation-actions">
                <button class="confirmation-btn cancel-btn" id="cancelRemoveNote">Cancelar</button>
                <button class="confirmation-btn confirm-btn" id="confirmRemoveNote">Apagar</button>
            </div>
        </div>
    </div>
    
    <div class="confirmation-modal" id="confirmRemoveTaskModal">
        <div class="confirmation-content">
            <h2 class="modal-title">Confirmar Remoção</h2>
            <p class="confirmation-message">Tem a certeza que deseja apagar esta tarefa?</p>
            <div class="confirmation-actions">
                <button class="confirmation-btn cancel-btn" id="cancelRemoveTask">Cancelar</button>
                <button class="confirmation-btn confirm-btn" id="confirmRemoveTask">Apagar</button>
            </div>
        </div>
    </div>
    
    <div class="confirmation-modal" id="confirmRemoveNoteTypeModal">
        <div class="confirmation-content">
            <h2 class="modal-title">Confirmar Remoção</h2>
            <p class="confirmation-message">Tem a certeza que deseja remover este tipo de nota?</p>
            <div class="confirmation-actions">
                <button class="confirmation-btn cancel-btn" id="cancelRemoveNoteType">Cancelar</button>
                <button class="confirmation-btn confirm-btn" id="confirmRemoveNoteType">Remover</button>
            </div>
        </div>
    </div>

    <script>
        // Dados da aplicação
        let pendingItems = JSON.parse(localStorage.getItem('pendingItems')) || [];
        let completedItems = JSON.parse(localStorage.getItem('completedItems')) || [];
        let notes = JSON.parse(localStorage.getItem('notes')) || [];
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        let noteTypes = JSON.parse(localStorage.getItem('noteTypes')) || ["Falta Fornecedor", "Baixa Sistema", "Emprestado", "Outro"];
        let profile = JSON.parse(localStorage.getItem('profile')) || { name: "" };
        
        let currentFilter = {
            text: '',
            startDate: null,
            endDate: null,
            type: ''
        };
        let currentNotesFilter = {
            text: '',
            startDate: null,
            endDate: null,
            type: ''
        };
        let currentNoteId = null;
        let currentTaskId = null;
        let checklistMode = false;
        let removeMode = false;
        let selectedItems = JSON.parse(localStorage.getItem('selectedItems')) || [];
        let itemToRemove = null;
        let noteToRemove = null;
        let taskToRemove = null;
        let noteTypeToRemove = null;
        let pendingItemToRemove = null;
        let editingPendingItemId = null;
        
        // Elementos DOM
        const homeView = document.getElementById('home-view');
        const historyView = document.getElementById('history-view');
        const notesView = document.getElementById('notes-view');
        const tasksView = document.getElementById('tasks-view');
        const settingsView = document.getElementById('settings-view');
        const checkItemBtn = document.getElementById('checkItemBtn');
        const addNoteBtn = document.getElementById('addNoteBtn');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const pendingList = document.getElementById('pendingList');
        const historyList = document.getElementById('historyList');
        const notesList = document.getElementById('notesList');
        const tasksList = document.getElementById('tasksList');
        const verificationModal = document.getElementById('verificationModal');
        const notesModal = document.getElementById('notesModal');
        const taskModal = document.getElementById('taskModal');
        const noteTypeModal = document.getElementById('noteTypeModal');
        const closeModalBtn = document.querySelectorAll('.close-modal');
        const saveBtn = document.getElementById('saveBtn');
        const waitBtn = document.getElementById('waitBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const homeBtn = document.getElementById('homeBtn');
        const historyBtn = document.getElementById('historyBtn');
        const notesBtn = document.getElementById('notesBtn');
        const tasksBtn = document.getElementById('tasksBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const filterBtn = document.getElementById('filterBtn');
        const checklistBtn = document.getElementById('checklistBtn');
        const removeModeBtn = document.getElementById('removeModeBtn');
        const clearFilterBtn = document.getElementById('clearFilterBtn');
        const filterModal = document.getElementById('filterModal');
        const applyFilterBtn = document.getElementById('applyFilterBtn');
        const clearFilterModalBtn = document.getElementById('clearFilterModalBtn');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const filterType = document.getElementById('filterType');
        const noteTitle = document.getElementById('noteTitle');
        const noteType = document.getElementById('noteType');
        const noteContent = document.getElementById('noteContent');
        const saveNoteBtn = document.getElementById('saveNoteBtn');
        const deleteNoteBtn = document.getElementById('deleteNoteBtn');
        const notesModalTitle = document.getElementById('notesModalTitle');
        const hasLotesCheckbox = document.getElementById('hasLotes');
        const lotesContainer = document.getElementById('lotesContainer');
        const addLoteBtn = document.getElementById('addLoteBtn');
        const standardQuantities = document.getElementById('standardQuantities');
        const standardQuantities2 = document.getElementById('standardQuantities2');
        const confirmRemovePendingModal = document.getElementById('confirmRemovePendingModal');
        const confirmRemoveHistoryModal = document.getElementById('confirmRemoveHistoryModal');
        const confirmRemoveNoteModal = document.getElementById('confirmRemoveNoteModal');
        const confirmRemoveTaskModal = document.getElementById('confirmRemoveTaskModal');
        const confirmRemoveNoteTypeModal = document.getElementById('confirmRemoveNoteTypeModal');
        const confirmRemovePending = document.getElementById('confirmRemovePending');
        const cancelRemovePending = document.getElementById('cancelRemovePending');
        const confirmRemoveHistory = document.getElementById('confirmRemoveHistory');
        const cancelRemoveHistory = document.getElementById('cancelRemoveHistory');
        const confirmRemoveNote = document.getElementById('confirmRemoveNote');
        const cancelRemoveNote = document.getElementById('cancelRemoveNote');
        const confirmRemoveTask = document.getElementById('confirmRemoveTask');
        const cancelRemoveTask = document.getElementById('cancelRemoveTask');
        const confirmRemoveNoteType = document.getElementById('confirmRemoveNoteType');
        const cancelRemoveNoteType = document.getElementById('cancelRemoveNoteType');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notificationMessage');
        const notesSearchInput = document.getElementById('notesSearchInput');
        const notesSearchBtn = document.getElementById('notesSearchBtn');
        const notesFilterBtn = document.getElementById('notesFilterBtn');
        const notesFilterModal = document.getElementById('notesFilterModal');
        const notesStartDate = document.getElementById('notesStartDate');
        const notesEndDate = document.getElementById('notesEndDate');
        const notesFilterType = document.getElementById('notesFilterType');
        const applyNotesFilterBtn = document.getElementById('applyNotesFilterBtn');
        const clearNotesFilterBtn = document.getElementById('clearNotesFilterBtn');
        const taskTitle = document.getElementById('taskTitle');
        const taskDescription = document.getElementById('taskDescription');
        const saveTaskBtn = document.getElementById('saveTaskBtn');
        const deleteTaskBtn = document.getElementById('deleteTaskBtn');
        const taskModalTitle = document.getElementById('taskModalTitle');
        const userName = document.getElementById('userName');
        const noteTypesList = document.getElementById('noteTypesList');
        const addNoteTypeBtn = document.getElementById('addNoteTypeBtn');
        const newNoteType = document.getElementById('newNoteType');
        const saveNoteTypeBtn = document.getElementById('saveNoteTypeBtn');
        
        // Elementos de estatísticas
        const completedCountEl = document.getElementById('completedCount');
        const pendingCountEl = document.getElementById('pendingCount');
        const notesCountEl = document.getElementById('notesCount');
        const tasksCountEl = document.getElementById('tasksCount');
        
        // Campos do modal de verificação
        const itemReference = document.getElementById('itemReference');
        const itemQuantityPc = document.getElementById('itemQuantityPc');
        const itemQuantityStock = document.getElementById('itemQuantityStock');
        const itemNotes = document.getElementById('itemNotes');
        
        // Variáveis para funcionalidade de arrastar
        let dragSrcEl = null;
        
        // Inicializar a aplicação
        function initApp() {
            // Definir datas padrão para o filtro
            const today = new Date().toISOString().split('T')[0];
            startDateInput.value = '2025-01-01';
            endDateInput.value = today;
            notesStartDate.value = '2025-01-01';
            notesEndDate.value = today;
            
            // Carregar dados do perfil
            userName.value = profile.name || '';
            
            updatePendingList();
            updateHistoryList();
            updateNotesList();
            updateTasksList();
            updateNoteTypesList();
            updateNoteTypeSelects();
            updateStats();
            
            // Event Listeners
            checkItemBtn.addEventListener('click', openVerificationModal);
            addNoteBtn.addEventListener('click', () => openNotesModal());
            addTaskBtn.addEventListener('click', () => openTaskModal());
            closeModalBtn.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (e.target.classList.contains('close-modal')) {
                        verificationModal.style.display = 'none';
                        notesModal.style.display = 'none';
                        taskModal.style.display = 'none';
                        noteTypeModal.style.display = 'none';
                        filterModal.style.display = 'none';
                        notesFilterModal.style.display = 'none';
                        confirmRemovePendingModal.style.display = 'none';
                        confirmRemoveHistoryModal.style.display = 'none';
                        confirmRemoveNoteModal.style.display = 'none';
                        confirmRemoveTaskModal.style.display = 'none';
                        confirmRemoveNoteTypeModal.style.display = 'none';
                        // Newly added modals
                        const scannerModalEl = document.getElementById('scannerModal');
                        const chooserModalEl = document.getElementById('chooserModal');
                        if (scannerModalEl) scannerModalEl.style.display = 'none';
                        if (chooserModalEl) chooserModalEl.style.display = 'none';
                        // Stop camera if scanner was open
                        try { stopScanner(); } catch (err) {}
                        
                        // Se estávamos editando um item pendente e fechamos o modal,
                        // não removemos o item da lista (correção solicitada)
                        if (editingPendingItemId !== null) {
                            editingPendingItemId = null;
                            // Recarregamos a lista para garantir que o item ainda aparece
                            updatePendingList();
                        }
                    }
                });
            });
            saveBtn.addEventListener('click', saveItem);
            waitBtn.addEventListener('click', saveAsPending);
            cancelBtn.addEventListener('click', closeVerificationModal);
            homeBtn.addEventListener('click', showHomeView);
            historyBtn.addEventListener('click', showHistoryView);
            notesBtn.addEventListener('click', showNotesView);
            tasksBtn.addEventListener('click', showTasksView);
            settingsBtn.addEventListener('click', showSettingsView);
            searchBtn.addEventListener('click', searchHistory);
            filterBtn.addEventListener('click', openFilterModal);
            checklistBtn.addEventListener('click', toggleChecklistMode);
            removeModeBtn.addEventListener('click', toggleRemoveMode);
            clearFilterBtn.addEventListener('click', clearFilter);
            applyFilterBtn.addEventListener('click', applyFilter);
            clearFilterModalBtn.addEventListener('click', clearFilterAndClose);
            saveNoteBtn.addEventListener('click', saveNote);
            deleteNoteBtn.addEventListener('click', () => {
                if (currentNoteId) {
                    noteToRemove = currentNoteId;
                    confirmRemoveNoteModal.style.display = 'flex';
                }
            });
            hasLotesCheckbox.addEventListener('change', toggleLotesContainer);
            addLoteBtn.addEventListener('click', addLoteRow);
            confirmRemovePending.addEventListener('click', removePendingItemConfirmed);
            cancelRemovePending.addEventListener('click', () => {
                confirmRemovePendingModal.style.display = 'none';
            });
            confirmRemoveHistory.addEventListener('click', removeHistoryItemConfirmed);
            cancelRemoveHistory.addEventListener('click', () => {
                confirmRemoveHistoryModal.style.display = 'none';
            });
            confirmRemoveNote.addEventListener('click', deleteNoteConfirmed);
            cancelRemoveNote.addEventListener('click', () => {
                confirmRemoveNoteModal.style.display = 'none';
            });
            confirmRemoveTask.addEventListener('click', deleteTaskConfirmed);
            cancelRemoveTask.addEventListener('click', () => {
                confirmRemoveTaskModal.style.display = 'none';
            });
            confirmRemoveNoteType.addEventListener('click', deleteNoteTypeConfirmed);
            cancelRemoveNoteType.addEventListener('click', () => {
                confirmRemoveNoteTypeModal.style.display = 'none';
            });
            
            // Event listeners para funcionalidades de anotações
            notesSearchBtn.addEventListener('click', searchNotes);
            notesFilterBtn.addEventListener('click', openNotesFilterModal);
            applyNotesFilterBtn.addEventListener('click', applyNotesFilter);
            clearNotesFilterBtn.addEventListener('click', clearNotesFilter);
            
            // Event listeners para tarefas
            saveTaskBtn.addEventListener('click', saveTask);
            deleteTaskBtn.addEventListener('click', () => {
                if (currentTaskId) {
                    taskToRemove = currentTaskId;
                    confirmRemoveTaskModal.style.display = 'flex';
                }
            });
            
            // Event listeners para tipos de nota
            addNoteTypeBtn.addEventListener('click', () => {
                newNoteType.value = '';
                noteTypeModal.style.display = 'flex';
            });
            saveNoteTypeBtn.addEventListener('click', saveNoteType);

            // Backup & Tools listeners
            const exportBtn = document.getElementById('exportDataBtn');
            const importBtn = document.getElementById('importDataBtn');
            const importInput = document.getElementById('importFileInput');
            const scannerBtn = document.getElementById('scannerBtn');
            const shareReportBtn = document.getElementById('shareReportBtn');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            exportBtn.addEventListener('click', exportData);
            importBtn.addEventListener('click', () => importInput.click());
            importInput.addEventListener('change', (e) => importData(e.target.files[0]));
            scannerBtn.addEventListener('click', () => { scannerModal.style.display = 'flex'; startScanner(); });
            shareReportBtn.addEventListener('click', shareReport);
            if (exportPdfBtn) exportPdfBtn.addEventListener('click', exportToPDF);
            
            // Event listener para perfil
            userName.addEventListener('change', saveProfile);
            
            // Fechar modais clicando fora deles
            window.addEventListener('click', (e) => {
                if (e.target === verificationModal) closeVerificationModal();
                if (e.target === notesModal) closeNotesModal();
                if (e.target === taskModal) closeTaskModal();
                if (e.target === noteTypeModal) closeNoteTypeModal();
                if (e.target === filterModal) closeFilterModal();
                if (e.target === notesFilterModal) closeNotesFilterModal();
                if (e.target === confirmRemovePendingModal) confirmRemovePendingModal.style.display = 'none';
                if (e.target === confirmRemoveHistoryModal) confirmRemoveHistoryModal.style.display = 'none';
                if (e.target === confirmRemoveNoteModal) confirmRemoveNoteModal.style.display = 'none';
                if (e.target === confirmRemoveTaskModal) confirmRemoveTaskModal.style.display = 'none';
                if (e.target === confirmRemoveNoteTypeModal) confirmRemoveNoteTypeModal.style.display = 'none';
                if (e.target === document.getElementById('scannerModal')) { stopScanner(); }
                if (e.target === document.getElementById('chooserModal')) { document.getElementById('chooserModal').style.display = 'none'; }
            });
            
            // Inicializar toggle dos lotes
            initToggles();

            // Force uppercase on itemReference input (preserve caret)
            if (itemReference) {
                itemReference.addEventListener('input', function(e) {
                    const el = e.target;
                    const start = el.selectionStart;
                    const end = el.selectionEnd;
                    const upper = el.value.toUpperCase();
                    if (el.value !== upper) {
                        el.value = upper;
                        // restore selection (try/catch for older browsers)
                        try {
                            el.setSelectionRange(start, end);
                        } catch (err) {
                            // ignore
                        }
                    }
                });
            }
        }

        // Export data as JSON (download)
        function exportData() {
            const payload = {
                pendingItems,
                completedItems,
                notes,
                tasks,
                noteTypes,
                profile
            };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            showNotification('Exportação iniciada');
        }

        // Import JSON file and merge basic structures
        function importData(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.pendingItems) pendingItems = data.pendingItems.concat(pendingItems || []);
                    if (data.completedItems) completedItems = data.completedItems.concat(completedItems || []);
                    if (data.notes) notes = data.notes.concat(notes || []);
                    if (data.tasks) tasks = data.tasks.concat(tasks || []);
                    if (data.noteTypes) noteTypes = Array.from(new Set((data.noteTypes || []).concat(noteTypes || [])));
                    if (data.profile) profile = Object.assign({}, profile, data.profile);

                    // Persist
                    localStorage.setItem('pendingItems', JSON.stringify(pendingItems));
                    localStorage.setItem('completedItems', JSON.stringify(completedItems));
                    localStorage.setItem('notes', JSON.stringify(notes));
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                    localStorage.setItem('noteTypes', JSON.stringify(noteTypes));
                    localStorage.setItem('profile', JSON.stringify(profile));

                    updatePendingList();
                    updateHistoryList();
                    updateNotesList();
                    updateTasksList();
                    updateNoteTypesList();
                    updateNoteTypeSelects();

                    showNotification('Importação concluída');
                } catch (err) {
                    console.error(err);
                    showNotification('Arquivo inválido');
                }
            };
            reader.readAsText(file);
        }
        
        // Abrir modal de verificação
        function openVerificationModal() {
            verificationModal.style.display = 'flex';
            itemReference.focus();
        }
        
        // Fechar modal de verificação
        function closeVerificationModal() {
            verificationModal.style.display = 'none';
            clearVerificationModalFields();
            editingPendingItemId = null; // Resetar o ID de edição ao fechar
        }
        
        // Limpar campos do modal de verificação
        function clearVerificationModalFields() {
            itemReference.value = '';
            itemQuantityPc.value = '';
            itemQuantityStock.value = '';
            itemNotes.value = '';
            hasLotesCheckbox.checked = false;
            lotesContainer.style.display = 'none';
            standardQuantities.style.display = 'block';
            standardQuantities2.style.display = 'block';
            
            // Remover todos os lotes exceto o primeiro
            const loteItems = lotesContainer.querySelectorAll('.lote-item');
            for (let i = 1; i < loteItems.length; i++) {
                loteItems[i].remove();
            }
            
            // Limpar o primeiro lote
            const firstLote = loteItems[0];
            firstLote.querySelector('.lote-name').value = '';
            firstLote.querySelector('.lote-pc').value = '';
            firstLote.querySelector('.lote-stock').value = '';
            
            // Expandir o primeiro lote
            firstLote.querySelector('.lote-details').classList.remove('collapsed');
            firstLote.querySelector('.lote-toggle').textContent = '−';
        }
        
        // Alternar visibilidade do container de lotes
        function toggleLotesContainer() {
            if (hasLotesCheckbox.checked) {
                lotesContainer.style.display = 'block';
                standardQuantities.style.display = 'none';
                standardQuantities2.style.display = 'none';
                // If a reference is already provided, try to auto-fill lotes from previous saves
                const ref = itemReference.value.trim();
                if (ref) {
                    const matches = findSavedLotes(ref);
                    if (matches && matches.length > 0) {
                        if (matches.length === 1) {
                            populateLotesFromArray(matches[0].item.lotes);
                            return;
                        } else {
                            // Show chooser modal to let user pick which verification to use
                            openChooserModal(matches);
                            return;
                        }
                    }
                }
            } else {
                lotesContainer.style.display = 'none';
                standardQuantities.style.display = 'block';
                standardQuantities2.style.display = 'block';
            }
        }
        
        // Inicializar toggles dos lotes
        function initToggles() {
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('lote-toggle')) {
                    const loteDetails = e.target.closest('.lote-item').querySelector('.lote-details');
                    loteDetails.classList.toggle('collapsed');
                    e.target.textContent = loteDetails.classList.contains('collapsed') ? '+' : '−';
                }
                
                if (e.target.classList.contains('remove-lote-btn')) {
                    const loteItem = e.target.closest('.lote-item');
                    if (lotesContainer.querySelectorAll('.lote-item').length > 1) {
                        loteItem.remove();
                    } else {
                        // Limpar o primeiro lote em vez de remover
                        loteItem.querySelector('.lote-name').value = '';
                        loteItem.querySelector('.lote-pc').value = '';
                        loteItem.querySelector('.lote-stock').value = '';
                    }
                }
            });
        }
        
        // Adicionar linha de lote
        function addLoteRow() {
            const loteItem = document.createElement('div');
            loteItem.className = 'lote-item';
            loteItem.innerHTML = `
                <div class="lote-header">
                    <div class="lote-name-container">
                        <input type="text" placeholder="Nome do Lote" class="lote-name">
                    </div>
                    <button class="lote-toggle">−</button>
                </div>
                <div class="lote-details">
                    <div class="lote-quantities">
                        <input type="number" placeholder="PC" class="lote-pc">
                    </div>
                    <div class="lote-quantities">
                        <input type="number" placeholder="Stock" class="lote-stock">
                    </div>
                    <button class="remove-lote-btn">&times;</button>
                </div>
            `;
            lotesContainer.insertBefore(loteItem, addLoteBtn);
        }

        // Search saved verifications (completed then pending) for lotes by reference
        // Returns array of matches [{source:'completed'|'pending', item}, ...]
        // Normalize references for tolerant matching
        function normalizeRef(s) {
            if (!s) return '';
            let o = s.toString().trim().toLowerCase();
            o = o.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            o = o.replace(/[^0-9a-z\-\s]/g, ' ');
            o = o.replace(/\s+/g, ' ').trim();
            return o;
        }

        function extractRefFromScanned(text) {
            if (!text) return null;
            // 1) try url param ?ref=
            let m = text.match(/[?&]ref=([^&\s]+)/i);
            if (m) return decodeURIComponent(m[1]).toUpperCase();
            // 2) try direct pattern LETTERS-NUMS
            m = text.match(/([A-Z]{2,}[\-\s]?\d{1,})/i);
            if (m) return m[1].replace(/\s+/g, '-').toUpperCase();
            // 3) fallback: clean string
            const cleaned = text.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^0-9A-Za-z\-]/g, '');
            return cleaned ? cleaned.toUpperCase() : null;
        }

        function findSavedLotes(reference) {
            if (!reference) return [];
            const refNorm = normalizeRef(reference);
            const matches = [];
            // Completed items first
            for (const item of completedItems) {
                if (item.lotes && item.lotes.length > 0) {
                    if (normalizeRef(item.reference) === refNorm) matches.push({ source: 'completed', item });
                }
            }
            // Then pending
            for (const item of pendingItems) {
                if (item.lotes && item.lotes.length > 0) {
                    if (normalizeRef(item.reference) === refNorm) matches.push({ source: 'pending', item });
                }
            }
            return matches;
        }

        // Populate the lotesContainer with an array of lotes [{name, pc, stock}, ...]
        // Temp store for previous lotes to support Undo
        let _previousLotesSnapshot = null;

        function populateLotesFromArray(lotesArray) {
            if (!Array.isArray(lotesArray) || lotesArray.length === 0) return;

            // Capture previous lotes state (serialize existing inputs)
            const existing = Array.from(lotesContainer.querySelectorAll('.lote-item'));
            const prev = existing.map(el => ({
                name: el.querySelector('.lote-name') ? el.querySelector('.lote-name').value : '',
                pc: el.querySelector('.lote-pc') ? el.querySelector('.lote-pc').value : '',
                stock: el.querySelector('.lote-stock') ? el.querySelector('.lote-stock').value : ''
            }));
            _previousLotesSnapshot = prev;

            // Remove existing lote items
            existing.forEach(el => el.remove());

            // Create items from provided array
            for (const lote of lotesArray) {
                const loteItem = document.createElement('div');
                loteItem.className = 'lote-item';
                loteItem.innerHTML = `
                    <div class="lote-header">
                        <div class="lote-name-container">
                            <input type="text" placeholder="Nome do Lote" class="lote-name" value="${(lote.name||'').replace(/"/g,'&quot;')}">
                        </div>
                        <button class="lote-toggle">−</button>
                    </div>
                    <div class="lote-details">
                        <div class="lote-quantities">
                            <input type="number" placeholder="PC" class="lote-pc" value="${lote.pc != null ? lote.pc : ''}">
                        </div>
                        <div class="lote-quantities">
                            <input type="number" placeholder="Stock" class="lote-stock" value="${lote.stock != null ? lote.stock : ''}">
                        </div>
                        <button class="remove-lote-btn">&times;</button>
                    </div>
                `;
                lotesContainer.insertBefore(loteItem, addLoteBtn);
            }

            // Show Undo notification so user can revert the auto-fill
            showActionNotification('Lotes preenchidos a partir de verificação anterior', 'Undo', () => {
                // Restore previous lotes
                const currentExisting = Array.from(lotesContainer.querySelectorAll('.lote-item'));
                currentExisting.forEach(el => el.remove());
                if (_previousLotesSnapshot && _previousLotesSnapshot.length > 0) {
                    for (const lote of _previousLotesSnapshot) {
                        const loteItem = document.createElement('div');
                        loteItem.className = 'lote-item';
                        loteItem.innerHTML = `
                            <div class="lote-header">
                                <div class="lote-name-container">
                                    <input type="text" placeholder="Nome do Lote" class="lote-name" value="${(lote.name||'').replace(/"/g,'&quot;')}">
                                </div>
                                <button class="lote-toggle">−</button>
                            </div>
                            <div class="lote-details">
                                <div class="lote-quantities">
                                    <input type="number" placeholder="PC" class="lote-pc" value="${lote.pc != null ? lote.pc : ''}">
                                </div>
                                <div class="lote-quantities">
                                    <input type="number" placeholder="Stock" class="lote-stock" value="${lote.stock != null ? lote.stock : ''}">
                                </div>
                                <button class="remove-lote-btn">&times;</button>
                            </div>
                        `;
                        lotesContainer.insertBefore(loteItem, addLoteBtn);
                    }
                }
                _previousLotesSnapshot = null;
            }, 7000);
        }

        function openChooserModal(matches) {
            const chooserModal = document.getElementById('chooserModal');
            const chooserList = document.getElementById('chooserList');
            chooserList.innerHTML = '';
            matches.forEach((m, idx) => {
                const row = document.createElement('div');
                row.style.padding = '8px';
                row.style.borderBottom = '1px solid #eee';
                const date = m.item.date || 'Sem data';
                row.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                        <div>
                            <div><strong>Origem:</strong> ${m.source}</div>
                            <div><small>${date}</small></div>
                        </div>
                        <div>
                            <button class="modal-btn btn-success chooser-choose">Usar</button>
                        </div>
                    </div>
                `;
                const btn = row.querySelector('.chooser-choose');
                btn.addEventListener('click', () => {
                    populateLotesFromArray(m.item.lotes);
                    chooserModal.style.display = 'none';
                });
                chooserList.appendChild(row);
            });
            chooserModal.style.display = 'flex';
        }
        
        // Mostrar notificação
        function showNotification(message) {
            notificationMessage.textContent = message;
            notification.classList.add('show');
            // hide any action by default
            const actionBtn = document.getElementById('notificationAction');
            if (actionBtn) actionBtn.style.display = 'none';

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Show notification with an action button (e.g., Undo)
        function showActionNotification(message, actionText, actionCallback, timeout = 5000) {
            notificationMessage.textContent = message;
            const actionBtn = document.getElementById('notificationAction');
            if (actionBtn) {
                actionBtn.textContent = actionText;
                actionBtn.style.display = 'inline-block';
                // Remove previous listeners
                const newBtn = actionBtn.cloneNode(true);
                actionBtn.parentNode.replaceChild(newBtn, actionBtn);
                newBtn.addEventListener('click', () => {
                    try { actionCallback(); } catch (err) { console.error(err); }
                    notification.classList.remove('show');
                    newBtn.style.display = 'none';
                });
            }
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
                const btn = document.getElementById('notificationAction');
                if (btn) btn.style.display = 'none';
            }, timeout);
        }
        
        // Salvar item (verificação completa)
        function saveItem() {
            const reference = itemReference.value.trim();
            const notesText = itemNotes.value.trim();
            
            if (!reference) {
                showNotification('Por favor, preencha a referência do artigo.');
                return;
            }
            
            let newItem;
            
            if (hasLotesCheckbox.checked) {
                // Validar lotes
                const loteItems = lotesContainer.querySelectorAll('.lote-item');
                const lotes = [];
                let isValid = true;
                
                for (const item of loteItems) {
                    const name = item.querySelector('.lote-name').value.trim();
                    const pc = item.querySelector('.lote-pc').value;
                    const stock = item.querySelector('.lote-stock').value;
                    
                    if (!name || !pc || !stock) {
                        isValid = false;
                        break;
                    }
                    
                    lotes.push({
                        name,
                        pc: parseInt(pc),
                        stock: parseInt(stock)
                    });
                }
                
                if (!isValid) {
                    showNotification('Por favor, preencha todos os campos dos lotes.');
                    return;
                }
                
                newItem = {
                    id: Date.now(),
                    reference,
                    notes: notesText,
                    date: new Date().toLocaleString('pt-PT'),
                    status: 'completed',
                    lotes: lotes
                };
            } else {
                const quantityPc = itemQuantityPc.value;
                const quantityStock = itemQuantityStock.value;
                
                if (!quantityPc || !quantityStock) {
                    showNotification('Por favor, preencha as quantidades.');
                    return;
                }
                
                newItem = {
                    id: Date.now(),
                    reference,
                    quantityPc: parseInt(quantityPc),
                    quantityStock: parseInt(quantityStock),
                    notes: notesText,
                    date: new Date().toLocaleString('pt-PT'),
                    status: 'completed'
                };
            }
            
            // Se estávamos editando, remover o item anterior
            if (editingPendingItemId !== null) {
                pendingItems = pendingItems.filter(item => item.id !== editingPendingItemId);
                editingPendingItemId = null;
            }
            
            completedItems.unshift(newItem);
            localStorage.setItem('completedItems', JSON.stringify(completedItems));
            localStorage.setItem('pendingItems', JSON.stringify(pendingItems));
            
            showNotification('Verificação guardada com sucesso!');
            closeVerificationModal();
            updateHistoryList();
            updatePendingList();
            updateStats();
        }
        
        // Salvar como pendente (aceita campos incompletos)
        function saveAsPending() {
            const reference = itemReference.value.trim();
            const notesText = itemNotes.value.trim();
            
            if (!reference) {
                showNotification('Por favor, preencha a referência do artigo.');
                return;
            }
            
            let newItem;
            
            if (hasLotesCheckbox.checked) {
                // Coletar lotes - aceita campos incompletos
                const loteItems = lotesContainer.querySelectorAll('.lote-item');
                const lotes = [];
                
                for (const item of loteItems) {
                    const name = item.querySelector('.lote-name').value.trim();
                    const pc = item.querySelector('.lote-pc').value;
                    const stock = item.querySelector('.lote-stock').value;
                    
                    // Aceita lotes com nome preenchido, mesmo que quantidades estejam vazias
                    if (name) {
                        lotes.push({
                            name,
                            pc: pc ? parseInt(pc) : 0,
                            stock: stock ? parseInt(stock) : 0
                        });
                    }
                }
                
                newItem = {
                    id: editingPendingItemId !== null ? editingPendingItemId : Date.now(),
                    reference,
                    notes: notesText,
                    date: new Date().toLocaleString('pt-PT'),
                    status: 'pending',
                    lotes: lotes.length > 0 ? lotes : undefined
                };
            } else {
                // Aceita valores vazios (serão guardados como 0)
                const quantityPc = itemQuantityPc.value || '0';
                const quantityStock = itemQuantityStock.value || '0';
                
                newItem = {
                    id: editingPendingItemId !== null ? editingPendingItemId : Date.now(),
                    reference,
                    quantityPc: parseInt(quantityPc),
                    quantityStock: parseInt(quantityStock),
                    notes: notesText,
                    date: new Date().toLocaleString('pt-PT'),
                    status: 'pending'
                };
            }
            
            // Se estávamos editando, remover o item anterior
            if (editingPendingItemId !== null) {
                pendingItems = pendingItems.filter(item => item.id !== editingPendingItemId);
            }
            
            pendingItems.unshift(newItem);
            localStorage.setItem('pendingItems', JSON.stringify(pendingItems));
            
            showNotification('Verificação guardada em espera!');
            closeVerificationModal();
            updatePendingList();
            updateStats();
            editingPendingItemId = null;
        }
        
        // Editar item pendente
        function editPendingItem(id) {
            const itemIndex = pendingItems.findIndex(item => item.id === id);
            
            if (itemIndex !== -1) {
                const item = pendingItems[itemIndex];
                
                // Preencher o modal com os dados do item
                itemReference.value = item.reference;
                
                if (item.lotes) {
                    hasLotesCheckbox.checked = true;
                    toggleLotesContainer();
                    
                    // Remover todos os lotes existentes
                    const loteItems = lotesContainer.querySelectorAll('.lote-item');
                    for (let i = 0; i < loteItems.length; i++) {
                        loteItems[i].remove();
                    }
                    
                    // Adicionar lotes do item
                    for (const lote of item.lotes) {
                        const loteItem = document.createElement('div');
                        loteItem.className = 'lote-item';
                        loteItem.innerHTML = `
                            <div class="lote-header">
                                <div class="lote-name-container">
                                    <input type="text" placeholder="Nome do Lote" class="lote-name" value="${lote.name}">
                                </div>
                                <button class="lote-toggle">−</button>
                            </div>
                            <div class="lote-details">
                                <div class="lote-quantities">
                                    <input type="number" placeholder="PC" class="lote-pc" value="${lote.pc}">
                                </div>
                                <div class="lote-quantities">
                                    <input type="number" placeholder="Stock" class="lote-stock" value="${lote.stock}">
                                </div>
                                <button class="remove-lote-btn">&times;</button>
                            </div>
                        `;
                        lotesContainer.insertBefore(loteItem, addLoteBtn);
                    }
                } else {
                    itemQuantityPc.value = item.quantityPc;
                    itemQuantityStock.value = item.quantityStock;
                }
                
                itemNotes.value = item.notes || '';
                
                // Guardar o ID do item que está sendo editado
                editingPendingItemId = id;
                
                // Abrir o modal
                openVerificationModal();
            }
        }
        
        // Remover item pendente
        function removePendingItem(id) {
            pendingItemToRemove = id;
            confirmRemovePendingModal.style.display = 'flex';
        }
        
        // Confirmar remoção de item pendente
        function removePendingItemConfirmed() {
            if (pendingItemToRemove) {
                pendingItems = pendingItems.filter(item => item.id !== pendingItemToRemove);
                localStorage.setItem('pendingItems', JSON.stringify(pendingItems));
                updatePendingList();
                updateStats();
                confirmRemovePendingModal.style.display = 'none';
                pendingItemToRemove = null;
                showNotification('Verificação em espera removida!');
            }
        }
        
        // Atualizar lista de pendentes
        function updatePendingList() {
            if (pendingItems.length === 0) {
                pendingList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clock" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <p>Nenhuma verificação em espera</p>
                    </div>
                `;
                return;
            }
            
            let pendingHTML = pendingItems.map(item => {
                let details = '';
                
                if (item.lotes) {
                    details = `${item.lotes.length} lote(s)`;
                } else {
                    details = `PC: ${item.quantityPc} | Stock: ${item.quantityStock}`;
                }
                
                return `
                <div class="pending-item">
                    <div class="item-info">
                        <div class="item-ref">${item.reference}</div>
                        <div class="item-details">
                            ${details}
                            ${item.notes ? ` | ${item.notes}` : ''}
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn edit" onclick="editPendingItem(${item.id})">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button class="action-btn delete" onclick="removePendingItem(${item.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                `;
            }).join('');
            
            pendingList.innerHTML = pendingHTML;
        }
        
        // Atualizar histórico
        function updateHistoryList() {
            let filteredItems = completedItems;
            
            // Aplicar filtro de texto
            if (currentFilter.text) {
                filteredItems = filteredItems.filter(item => 
                    item.reference.toLowerCase().includes(currentFilter.text.toLowerCase())
                );
            }
            
            // Aplicar filtro de data
            if (currentFilter.startDate && currentFilter.endDate) {
                filteredItems = filteredItems.filter(item => {
                    const itemDate = new Date(item.date.split(',')[0].split('/').reverse().join('-'));
                    return itemDate >= currentFilter.startDate && itemDate <= currentFilter.endDate;
                });
            }
            
            // Aplicar filtro de tipo (checklist)
            if (currentFilter.type) {
                if (currentFilter.type === 'checked') {
                    filteredItems = filteredItems.filter(item => selectedItems.includes(item.id));
                } else if (currentFilter.type === 'unchecked') {
                    filteredItems = filteredItems.filter(item => !selectedItems.includes(item.id));
                }
            }
            
            if (filteredItems.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                    <i class="fas fa-history" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                    <p>Nenhuma verificação no histórico</p>
                    </div>
                `;
                return;
            }
            
            let historyHTML = filteredItems.map(item => {
                const isSelected = selectedItems.includes(item.id);
                let content = '';
                
                if (item.lotes) {
                    // Calcular totais
                    let totalPc = 0;
                    let totalStock = 0;
                    
                    for (const lote of item.lotes) {
                        totalPc += lote.pc;
                        totalStock += lote.stock;
                    }
                    
                    const totalDifference = totalStock - totalPc;
                    const totalDifferenceClass = totalDifference >= 0 ? 'positive' : 'negative';
                    const totalDifferenceSymbol = totalDifference >= 0 ? '+' : '';
                    
                    // Construir tabela de lotes
                    let lotesTable = `
                    <table class="lotes-table">
                        <thead>
                            <tr>
                                <th>Lote</th>
                                <th>PC</th>
                                <th>Stock</th>
                                <th>Diferença</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    
                    for (const lote of item.lotes) {
                        const difference = lote.stock - lote.pc;
                        const differenceClass = difference >= 0 ? 'positive' : 'negative';
                        const differenceSymbol = difference >= 0 ? '+' : '';
                        
                        lotesTable += `
                            <tr>
                                <td>${lote.name}</td>
                                <td>${lote.pc}</td>
                                <td>${lote.stock}</td>
                                <td><span class="${differenceClass}">${differenceSymbol}${difference}</span></td>
                            </tr>
                        `;
                    }
                    
                    lotesTable += `
                        </tbody>
                        <tfoot>
                            <tr>
                                <td><strong>Total</strong></td>
                                <td><strong>${totalPc}</strong></td>
                                <td><strong>${totalStock}</strong></td>
                                <td><span class="${totalDifferenceClass}">${totalDifferenceSymbol}${totalDifference}</span></td>
                            </tr>
                        </tfoot>
                    </table>
                    `;
                    
                    content = `
                    <div class="history-item ${isSelected ? 'selected' : ''}" data-id="${item.id}">
                        ${checklistMode ? `
                        <input type="checkbox" class="history-checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelectItem(${item.id}, this.checked)">
                        ` : ''}
                        <div style="flex: 1;">
                            <div class="history-header">
                                <span class="history-ref">${item.reference}</span>
                                <span class="history-date">${item.date}</span>
                            </div>
                            ${lotesTable}
                            ${item.notes ? `<div class="history-notes">${item.notes}</div>` : ''}
                        </div>
                        ${removeMode ? `
                        <button class="history-remove-btn" onclick="removeHistoryItem(${item.id})">
                            <i class="fas fa-times"></i>
                        </button>
                        ` : ''}
                    </div>
                    `;
                } else {
                    const difference = item.quantityStock - item.quantityPc;
                    const differenceClass = difference >= 0 ? 'positive' : 'negative';
                    const differenceSymbol = difference >= 0 ? '+' : '';
                    
                    content = `
                    <div class="history-item ${isSelected ? 'selected' : ''}" data-id="${item.id}">
                        ${checklistMode ? `
                        <input type="checkbox" class="history-checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelectItem(${item.id}, this.checked)">
                        ` : ''}
                        <div style="flex: 1;">
                            <div class="history-header">
                                <span class="history-ref">${item.reference}</span>
                                <span class="history-date">${item.date}</span>
                            </div>
                            <div class="history-details">
                                <div>
                                    <div class="history-quantity">PC: ${item.quantityPc}</div>
                                    <div class="history-quantity">Stock: ${item.quantityStock}</div>
                                </div>
                                <span class="history-difference ${differenceClass}">${differenceSymbol}${difference}</span>
                            </div>
                            ${item.notes ? `<div class="history-notes">${item.notes}</div>` : ''}
                        </div>
                        ${removeMode ? `
                        <button class="history-remove-btn" onclick="removeHistoryItem(${item.id})">
                            <i class="fas fa-times"></i>
                        </button>
                        ` : ''}
                    </div>
                    `;
                }
                
                return content;
            }).join('');
            
            historyList.innerHTML = historyHTML;
            
            // Mostrar ou esconder botões de remoção baseado no modo
            const removeButtons = historyList.querySelectorAll('.history-remove-btn');
            removeButtons.forEach(btn => {
                btn.style.display = removeMode ? 'block' : 'none';
            });
        }
        
        // Alternar modo checklist
        function toggleChecklistMode() {
            checklistMode = !checklistMode;
            removeMode = false;
            updateHistoryList();
            updateButtonStates();
        }
        
        // Alternar modo de remoção
        function toggleRemoveMode() {
            removeMode = !removeMode;
            checklistMode = false;
            updateHistoryList();
            updateButtonStates();
        }
        
        // Atualizar estado dos botões
        function updateButtonStates() {
            checklistBtn.style.opacity = checklistMode ? '1' : '0.7';
            removeModeBtn.style.opacity = removeMode ? '1' : '0.7';
        }
        
        // Selecionar/desselecionar item
        function toggleSelectItem(id, isChecked) {
            if (isChecked) {
                if (!selectedItems.includes(id)) {
                    selectedItems.push(id);
                }
            } else {
                selectedItems = selectedItems.filter(itemId => itemId !== id);
            }
            
            // Guardar no localStorage
            localStorage.setItem('selectedItems', JSON.stringify(selectedItems));
            
            // Atualizar a lista para refletir as mudanças
            updateHistoryList();
        }
        
        // Remover item do histórico
        function removeHistoryItem(id) {
            itemToRemove = id;
            confirmRemoveHistoryModal.style.display = 'flex';
        }
        
        // Confirmar remoção de item do histórico
        function removeHistoryItemConfirmed() {
            if (itemToRemove) {
                completedItems = completedItems.filter(item => item.id !== itemToRemove);
                localStorage.setItem('completedItems', JSON.stringify(completedItems));
                
                // Remover também dos selecionados se estiver lá
                selectedItems = selectedItems.filter(itemId => itemId !== itemToRemove);
                localStorage.setItem('selectedItems', JSON.stringify(selectedItems));
                
                updateHistoryList();
                updateStats();
                confirmRemoveHistoryModal.style.display = 'none';
                itemToRemove = null;
                showNotification('Item do histórico removido!');
            }
        }
        
        // Atualizar estatísticas
        function updateStats() {
            completedCountEl.textContent = completedItems.length;
            pendingCountEl.textContent = pendingItems.length;
            notesCountEl.textContent = notes.length;
            tasksCountEl.textContent = tasks.length;
        }
        
        // Pesquisar no histórico
        function searchHistory() {
            currentFilter.text = searchInput.value.trim();
            updateHistoryList();
        }
        
        // Abrir modal de filtro
        function openFilterModal() {
            filterModal.style.display = 'flex';
        }
        
        // Fechar modal de filtro
        function closeFilterModal() {
            filterModal.style.display = 'none';
        }
        
        // Aplicar filtro
        function applyFilter() {
            currentFilter.startDate = new Date(startDateInput.value);
            currentFilter.endDate = new Date(endDateInput.value);
            currentFilter.type = filterType.value;
            
            // Ajustar para incluir todo o dia final
            currentFilter.endDate.setHours(23, 59, 59, 999);
            
            closeFilterModal();
            updateHistoryList();
        }
        
        // Limpar filtro e fechar modal
        function clearFilterAndClose() {
            clearFilter();
            closeFilterModal();
        }
        
        // Limpar filtro
        function clearFilter() {
            currentFilter = {
                text: '',
                startDate: null,
                endDate: null,
                type: ''
            };
            searchInput.value = '';
            startDateInput.value = '2025-01-01';
            endDateInput.value = new Date().toISOString().split('T')[0];
            filterType.value = '';
            checklistMode = false;
            removeMode = false;
            updateHistoryList();
            updateButtonStates();
        }
        
        // Mostrar view inicial
        function showHomeView() {
            homeView.style.display = 'block';
            historyView.style.display = 'none';
            notesView.style.display = 'none';
            tasksView.style.display = 'none';
            settingsView.style.display = 'none';
            homeBtn.classList.add('active');
            historyBtn.classList.remove('active');
            notesBtn.classList.remove('active');
            tasksBtn.classList.remove('active');
            settingsBtn.classList.remove('active');
            
            // Sair dos modos ao mudar de view
            checklistMode = false;
            removeMode = false;
            updateButtonStates();
        }
        
        // Mostrar view de histórico
        function showHistoryView() {
            homeView.style.display = 'none';
            historyView.style.display = 'block';
            notesView.style.display = 'none';
            tasksView.style.display = 'none';
            settingsView.style.display = 'none';
            homeBtn.classList.remove('active');
            historyBtn.classList.add('active');
            notesBtn.classList.remove('active');
            tasksBtn.classList.remove('active');
            settingsBtn.classList.remove('active');
            updateHistoryList();
        }
        
        // Mostrar view de anotações
        function showNotesView() {
            homeView.style.display = 'none';
            historyView.style.display = 'none';
            notesView.style.display = 'block';
            tasksView.style.display = 'none';
            settingsView.style.display = 'none';
            homeBtn.classList.remove('active');
            historyBtn.classList.remove('active');
            notesBtn.classList.add('active');
            tasksBtn.classList.remove('active');
            settingsBtn.classList.remove('active');
            updateNotesList();
            
            // Sair dos modos ao mudar de view
            checklistMode = false;
            removeMode = false;
            updateButtonStates();
        }
        
        // Mostrar view de tarefas
        function showTasksView() {
            homeView.style.display = 'none';
            historyView.style.display = 'none';
            notesView.style.display = 'none';
            tasksView.style.display = 'block';
            settingsView.style.display = 'none';
            homeBtn.classList.remove('active');
            historyBtn.classList.remove('active');
            notesBtn.classList.remove('active');
            tasksBtn.classList.add('active');
            settingsBtn.classList.remove('active');
            updateTasksList();
            
            // Sair dos modos ao mudar de view
            checklistMode = false;
            removeMode = false;
            updateButtonStates();
        }
        
        // Mostrar view de definições
        function showSettingsView() {
            homeView.style.display = 'none';
            historyView.style.display = 'none';
            notesView.style.display = 'none';
            tasksView.style.display = 'none';
            settingsView.style.display = 'block';
            homeBtn.classList.remove('active');
            historyBtn.classList.remove('active');
            notesBtn.classList.remove('active');
            tasksBtn.classList.remove('active');
            settingsBtn.classList.add('active');
            
            // Sair dos modos ao mudar de view
            checklistMode = false;
            removeMode = false;
            updateButtonStates();
        }
        
        // Abrir modal de anotações
        function openNotesModal(note = null) {
            if (note && typeof note === 'object') {
                // Editar nota existente
                currentNoteId = note.id;
                noteTitle.value = note.title;
                noteContent.value = note.content;
                updateNoteTypeSelects(note.type);
                notesModalTitle.textContent = 'Editar Anotação';
                deleteNoteBtn.style.display = 'block';
            } else {
                // Nova nota
                currentNoteId = null;
                noteTitle.value = '';
                noteContent.value = '';
                updateNoteTypeSelects();
                notesModalTitle.textContent = 'Nova Anotação';
                deleteNoteBtn.style.display = 'none';
            }
            notesModal.style.display = 'flex';
        }
        
        // Fechar modal de anotações
        function closeNotesModal() {
            notesModal.style.display = 'none';
        }
        
        // Salvar anotação
        function saveNote() {
            const title = noteTitle.value.trim();
            const content = noteContent.value.trim();
            const type = document.getElementById('noteType').value;
            
            if (!title || !content) {
                showNotification('Por favor, preencha o título e o conteúdo.');
                return;
            }
            
            if (currentNoteId) {
                // Atualizar nota existente
                const noteIndex = notes.findIndex(note => note.id === currentNoteId);
                if (noteIndex !== -1) {
                    notes[noteIndex] = { 
                        id: currentNoteId, 
                        title, 
                        content,
                        type,
                        date: notes[noteIndex].date // Mantém a data original
                    };
                }
            } else {
                // Adicionar nova nota
                const newNote = {
                    id: Date.now(),
                    title,
                    content,
                    type,
                    date: new Date().toLocaleString('pt-PT')
                };
                notes.unshift(newNote);
            }
            
            localStorage.setItem('notes', JSON.stringify(notes));
            updateNotesList();
            updateStats();
            closeNotesModal();
            showNotification('Anotação guardada com sucesso!');
        }
        
        // Apagar anotação
        function deleteNoteConfirmed() {
            if (noteToRemove) {
                notes = notes.filter(note => note.id !== noteToRemove);
                localStorage.setItem('notes', JSON.stringify(notes));
                updateNotesList();
                updateStats();
                closeNotesModal();
                confirmRemoveNoteModal.style.display = 'none';
                noteToRemove = null;
                showNotification('Anotação removida com sucesso!');
            }
        }
        
        // Pesquisar anotações
        function searchNotes() {
            currentNotesFilter.text = notesSearchInput.value.trim();
            updateNotesList();
        }
        
        // Abrir modal de filtro de anotações
        function openNotesFilterModal() {
            notesFilterModal.style.display = 'flex';
        }
        
        // Fechar modal de filtro de anotações
        function closeNotesFilterModal() {
            notesFilterModal.style.display = 'none';
        }
        
        // Aplicar filtro de anotações
        function applyNotesFilter() {
            currentNotesFilter.startDate = new Date(notesStartDate.value);
            currentNotesFilter.endDate = new Date(notesEndDate.value);
            currentNotesFilter.type = notesFilterType.value;
            
            // Ajustar para incluir todo o dia final
            if (currentNotesFilter.endDate) {
                currentNotesFilter.endDate.setHours(23, 59, 59, 999);
            }
            
            closeNotesFilterModal();
            updateNotesList();
        }
        
        // Limpar filtro de anotações
        function clearNotesFilter() {
            currentNotesFilter = {
                text: '',
                startDate: null,
                endDate: null,
                type: ''
            };
            notesSearchInput.value = '';
            notesStartDate.value = '2025-01-01';
            notesEndDate.value = new Date().toISOString().split('T')[0];
            notesFilterType.value = '';
            updateNotesList();
            closeNotesFilterModal();
        }
        
        // Atualizar lista de anotações
        function updateNotesList() {
            let filteredNotes = notes;
            
            // Aplicar filtro de texto
            if (currentNotesFilter.text) {
                filteredNotes = filteredNotes.filter(note => 
                    note.title.toLowerCase().includes(currentNotesFilter.text.toLowerCase())
                );
            }
            
            // Aplicar filtro de data
            if (currentNotesFilter.startDate && currentNotesFilter.endDate) {
                filteredNotes = filteredNotes.filter(note => {
                    const noteDate = new Date(note.date.split(',')[0].split('/').reverse().join('-'));
                    return noteDate >= currentNotesFilter.startDate && noteDate <= currentNotesFilter.endDate;
                });
            }
            
            // Aplicar filtro de tipo
            if (currentNotesFilter.type) {
                filteredNotes = filteredNotes.filter(note => note.type === currentNotesFilter.type);
            }
            
            if (filteredNotes.length === 0) {
                notesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-sticky-note" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <p>Nenhuma anotação</p>
                    </div>
                `;
                return;
            }
            
            notesList.innerHTML = filteredNotes.map(note => `
                <div class="note-item">
                    <div class="item-info">
                        <div class="note-title">${note.title}</div>
                        <div class="note-date">${note.date}</div>
                        ${note.type ? `<div class="note-type">Tipo: ${note.type}</div>` : ''}
                    </div>
                    <div class="item-actions">
                        <button class="action-btn edit" onclick="openNotesModal(${JSON.stringify(note).replace(/"/g, '&quot;')})">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Abrir modal de tarefas
        function openTaskModal(task = null) {
            if (task && typeof task === 'object') {
                // Editar tarefa existente
                currentTaskId = task.id;
                taskTitle.value = task.title;
                taskDescription.value = task.description;
                taskModalTitle.textContent = 'Editar Tarefa';
                deleteTaskBtn.style.display = 'block';
            } else {
                // Nova tarefa
                currentTaskId = null;
                taskTitle.value = '';
                taskDescription.value = '';
                taskModalTitle.textContent = 'Nova Tarefa';
                deleteTaskBtn.style.display = 'none';
            }
            taskModal.style.display = 'flex';
        }
        
        // Fechar modal de tarefas
        function closeTaskModal() {
            taskModal.style.display = 'none';
        }
        
        // Salvar tarefa
        function saveTask() {
            const title = taskTitle.value.trim();
            const description = taskDescription.value.trim();
            
            if (!title) {
                showNotification('Por favor, preencha o título da tarefa.');
                return;
            }
            
            if (currentTaskId) {
                // Atualizar tarefa existente
                const taskIndex = tasks.findIndex(task => task.id === currentTaskId);
                if (taskIndex !== -1) {
                    tasks[taskIndex] = { 
                        id: currentTaskId, 
                        title, 
                        description,
                        date: tasks[taskIndex].date // Mantém a data original
                    };
                }
            } else {
                // Adicionar nova tarefa
                const newTask = {
                    id: Date.now(),
                    title,
                    description,
                    date: new Date().toLocaleString('pt-PT')
                };
                tasks.unshift(newTask);
            }
            
            localStorage.setItem('tasks', JSON.stringify(tasks));
            updateTasksList();
            updateStats();
            closeTaskModal();
            showNotification('Tarefa guardada com sucesso!');
        }
        
        // Apagar tarefa
        function deleteTaskConfirmed() {
            if (taskToRemove) {
                tasks = tasks.filter(task => task.id !== taskToRemove);
                localStorage.setItem('tasks', JSON.stringify(tasks));
                updateTasksList();
                updateStats();
                closeTaskModal();
                confirmRemoveTaskModal.style.display = 'none';
                taskToRemove = null;
                showNotification('Tarefa removida com sucesso!');
            }
        }
        
        // Atualizar lista de tarefas
        function updateTasksList() {
            if (tasks.length === 0) {
                tasksList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-tasks" style="font-size: 1.5rem; margin-bottom: 8px;"></i>
                        <p>Nenhuma tarefa</p>
                    </div>
                `;
                return;
            }
            
            tasksList.innerHTML = tasks.map(task => `
                <div class="task-item">
                    <div class="item-info">
                        <div class="task-title">${task.title}</div>
                        <div class="task-date">${task.date}</div>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn edit" onclick="openTaskModal(${JSON.stringify(task).replace(/"/g, '&quot;')})">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Salvar perfil
        function saveProfile() {
            profile.name = userName.value;
            localStorage.setItem('profile', JSON.stringify(profile));
            showNotification('Perfil guardado com sucesso!');
        }
        
        // Salvar tipo de nota
        function saveNoteType() {
            const type = newNoteType.value.trim();
            
            if (!type) {
                showNotification('Por favor, preencha o tipo de nota.');
                return;
            }
            
            if (noteTypes.includes(type)) {
                showNotification('Este tipo de nota já existe.');
                return;
            }
            
            noteTypes.push(type);
            localStorage.setItem('noteTypes', JSON.stringify(noteTypes));
            updateNoteTypesList();
            updateNoteTypeSelects();
            closeNoteTypeModal();
            showNotification('Tipo de nota adicionado com sucesso!');
        }
        
        // Fechar modal de tipo de nota
        function closeNoteTypeModal() {
            noteTypeModal.style.display = 'none';
        }
        
        // Remover tipo de nota
        function removeNoteType(type) {
            noteTypeToRemove = type;
            confirmRemoveNoteTypeModal.style.display = 'flex';
        }
        
        // Confirmar remoção de tipo de nota
        function deleteNoteTypeConfirmed() {
            if (noteTypeToRemove) {
                noteTypes = noteTypes.filter(type => type !== noteTypeToRemove);
                localStorage.setItem('noteTypes', JSON.stringify(noteTypes));
                updateNoteTypesList();
                updateNoteTypeSelects();
                confirmRemoveNoteTypeModal.style.display = 'none';
                noteTypeToRemove = null;
                showNotification('Tipo de nota removido com sucesso!');
            }
        }
        
        // Atualizar lista de tipos de nota
        function updateNoteTypesList() {
            // Remove any null/empty entries that may have sneaked into the array
            noteTypes = noteTypes.filter(t => t != null && t !== '');
            noteTypesList.innerHTML = noteTypes.map(type => `
                <div class="note-type-item" draggable="true" data-type="${type}">
                    <div class="drag-handle">
                        <i class="fas fa-grip-lines"></i>
                    </div>
                    <span class="note-type-name">${type}</span>
                    <button class="action-btn delete" onclick="removeNoteType('${type}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
            
            // Adicionar event listeners para drag and drop
            const items = noteTypesList.querySelectorAll('.note-type-item');
            items.forEach(item => {
                // HTML5 drag for desktop
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);

                // Pointer/touch handlers on the drag handle for mobile
                const handle = item.querySelector('.drag-handle');
                if (handle) {
                    // Use pointerdown which unifies mouse/touch
                    handle.addEventListener('pointerdown', pointerDownHandler);
                    // Also support touchstart for older mobile browsers
                    handle.addEventListener('touchstart', function(e) { pointerDownHandler.call(handle, e); }, { passive: false });
                }
            });
        }
        
        // Atualizar selects de tipo de nota
        function updateNoteTypeSelects(selectedValue = '') {
            // Atualizar o select no modal de anotações
            const noteTypeSelect = document.getElementById('noteType');
            noteTypeSelect.innerHTML = noteTypes.map(type => 
                `<option value="${type}" ${type === selectedValue ? 'selected' : ''}>${type}</option>`
            ).join('');
            
            // Atualizar o select no modal de filtro de anotações
            const notesFilterTypeSelect = document.getElementById('notesFilterType');
            notesFilterTypeSelect.innerHTML = '<option value="">Todos os tipos</option>' + 
                noteTypes.map(type => `<option value="${type}">${type}</option>`).join('');
        }
        
        // Funções para drag and drop
        function handleDragStart(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
            
            this.classList.add('dragging');
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (dragSrcEl !== this) {
                // Try to compute indices based on data-type; if anything is invalid, rebuild from DOM order
                const srcType = dragSrcEl ? dragSrcEl.getAttribute('data-type') : null;
                const destType = this.getAttribute('data-type');
                let srcIndex = noteTypes.indexOf(srcType);
                let destIndex = noteTypes.indexOf(destType);

                if (srcIndex === -1 || destIndex === -1) {
                    // Fallback: rebuild noteTypes from DOM in current order, ignoring falsy values
                    const domItems = Array.from(noteTypesList.querySelectorAll('.note-type-item'));
                    noteTypes = domItems.map(it => it.getAttribute('data-type')).filter(t => t != null && t !== '');
                } else {
                    const [movedItem] = noteTypes.splice(srcIndex, 1);
                    if (typeof movedItem !== 'undefined' && movedItem != null) {
                        noteTypes.splice(destIndex, 0, movedItem);
                    } else {
                        // Unexpected undefined movedItem — fallback to DOM order
                        const domItems = Array.from(noteTypesList.querySelectorAll('.note-type-item'));
                        noteTypes = domItems.map(it => it.getAttribute('data-type')).filter(t => t != null && t !== '');
                    }
                }

                // Salvar no localStorage
                localStorage.setItem('noteTypes', JSON.stringify(noteTypes));

                // Atualizar a lista
                updateNoteTypesList();
                updateNoteTypeSelects();
            }
            
            return false;
        }
        
        function handleDragEnd(e) {
            this.classList.remove('dragging');
        }

        // Pointer-based dragging for touch / mobile devices
        let pointerDrag = {
            draggingEl: null,
            placeholder: null,
            startY: 0,
            offsetY: 0
        };

        function pointerDownHandler(e) {
            // Only start when pressing on the drag-handle or the item itself
            const item = this.closest('.note-type-item');
            if (!item) return;

            // Prevent the native touch scrolling while dragging
            e.preventDefault();

            pointerDrag.draggingEl = item;
            pointerDrag.startY = (e.touches ? e.touches[0].clientY : e.clientY);

            // Create placeholder
            const rect = item.getBoundingClientRect();
            const placeholder = document.createElement('div');
            placeholder.className = 'note-type-item placeholder';
            placeholder.style.height = rect.height + 'px';
            placeholder.style.background = 'rgba(0,0,0,0.05)';
            placeholder.style.border = '2px dashed #ccc';
            item.parentNode.insertBefore(placeholder, item.nextSibling);
            pointerDrag.placeholder = placeholder;

            // Style dragged element
            item.classList.add('dragging');
            item.style.position = 'relative';
            item.style.zIndex = 50;
            item.style.width = '100%';
            pointerDrag.offsetY = 0;

            // Listen for move / up on document
            document.addEventListener('pointermove', pointerMoveHandler);
            document.addEventListener('pointerup', pointerUpHandler);
            document.addEventListener('touchmove', pointerMoveHandler, { passive: false });
            document.addEventListener('touchend', pointerUpHandler);
        }

        function pointerMoveHandler(e) {
            if (!pointerDrag.draggingEl) return;
            // Prevent scrolling
            if (e.cancelable) e.preventDefault();

            const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
            const dy = clientY - pointerDrag.startY;
            pointerDrag.offsetY = dy;
            pointerDrag.draggingEl.style.transform = `translateY(${dy}px)`;

            // Detect position to move placeholder
            const items = Array.from(noteTypesList.querySelectorAll('.note-type-item'))
                .filter(it => it !== pointerDrag.draggingEl && it !== pointerDrag.placeholder);

            for (const it of items) {
                const r = it.getBoundingClientRect();
                const mid = r.top + r.height / 2;
                if (clientY < mid) {
                    if (pointerDrag.placeholder.nextSibling !== it) {
                        it.parentNode.insertBefore(pointerDrag.placeholder, it);
                    }
                    break;
                } else {
                    if (!it.nextSibling) {
                        it.parentNode.appendChild(pointerDrag.placeholder);
                    } else if (it.nextSibling === pointerDrag.placeholder) {
                        // already in place
                    }
                }
            }
        }

        function pointerUpHandler(e) {
            if (!pointerDrag.draggingEl) return;

            // Insert the draggingEl where placeholder is
            const parent = pointerDrag.placeholder.parentNode;

            // FLIP animation: First, get the first bounding rect of the dragged element
            const firstRect = pointerDrag.draggingEl.getBoundingClientRect();

            parent.insertBefore(pointerDrag.draggingEl, pointerDrag.placeholder);

            // Get the last bounding rect after insertion
            const lastRect = pointerDrag.draggingEl.getBoundingClientRect();

            // Compute the inverse delta
            const deltaX = firstRect.left - lastRect.left;
            const deltaY = firstRect.top - lastRect.top;

            // Apply inverse transform so element appears to be at the original position
            pointerDrag.draggingEl.style.transform = `translate(${deltaX}px, ${deltaY}px)`;

            // Force reflow
            // eslint-disable-next-line no-unused-expressions
            pointerDrag.draggingEl.offsetWidth;

            // Add class to enable transition and animate to identity (0,0)
            pointerDrag.draggingEl.classList.add('release-anim');
            pointerDrag.draggingEl.style.transform = 'translate(0, 0)';

            // After transition ends, cleanup and persist order
            const onTransitionEnd = (ev) => {
                if (ev.target !== pointerDrag.draggingEl) return;

                // Cleanup styles
                pointerDrag.draggingEl.classList.remove('dragging');
                pointerDrag.draggingEl.classList.remove('release-anim');
                pointerDrag.draggingEl.style.transform = '';
                pointerDrag.draggingEl.style.position = '';
                pointerDrag.draggingEl.style.zIndex = '';
                pointerDrag.draggingEl.style.width = '';

                // Remove placeholder
                if (pointerDrag.placeholder && pointerDrag.placeholder.parentNode) {
                    pointerDrag.placeholder.remove();
                }

                // Rebuild noteTypes array based on DOM order — ignore falsy data-type values
                const items = Array.from(noteTypesList.querySelectorAll('.note-type-item'));
                noteTypes = items.map(it => it.getAttribute('data-type')).filter(t => t != null && t !== '');
                localStorage.setItem('noteTypes', JSON.stringify(noteTypes));

                // Re-render to ensure event handlers are bound correctly
                updateNoteTypesList();

                // Remove document listeners
                document.removeEventListener('pointermove', pointerMoveHandler);
                document.removeEventListener('pointerup', pointerUpHandler);
                document.removeEventListener('touchmove', pointerMoveHandler);
                document.removeEventListener('touchend', pointerUpHandler);

                // Remove transition listener
                pointerDrag.draggingEl.removeEventListener('transitionend', onTransitionEnd);

                // Reset pointerDrag state
                pointerDrag.draggingEl = null;
                pointerDrag.placeholder = null;
                pointerDrag.startY = 0;
                pointerDrag.offsetY = 0;
            };

            pointerDrag.draggingEl.addEventListener('transitionend', onTransitionEnd);
        }
        
        // Iniciar a aplicação quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', initApp);

        // Create a simple CSV report and share via Web Share API or download
        function shareReport() {
            // Build CSV header
            let csv = 'type,id,reference,date,details\n';
            for (const it of completedItems) {
                const details = it.lotes ? `lotes:${it.lotes.length}` : `pc:${it.quantityPc}|stock:${it.quantityStock}`;
                csv += `completed,${it.id},"${it.reference}","${it.date}","${details}"\n`;
            }
            for (const it of pendingItems) {
                const details = it.lotes ? `lotes:${it.lotes.length}` : `pc:${it.quantityPc}|stock:${it.quantityStock}`;
                csv += `pending,${it.id},"${it.reference}","${it.date}","${details}"\n`;
            }

            const blob = new Blob([csv], { type: 'text/csv' });
            const file = new File([blob], `report-${new Date().toISOString().slice(0,10)}.csv`, { type: 'text/csv' });

            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                navigator.share({ files: [file], title: 'Relatório Verificações' })
                    .then(() => showNotification('Relatório partilhado'))
                    .catch(err => { console.error(err); showNotification('Partilha cancelada'); });
            } else {
                // Fallback: download
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                showNotification('Relatório gerado (download)');
            }
        }

        // PDF export (lazy-load jsPDF from CDN)
        async function exportToPDF() {
            showNotification('A gerar PDF...');
            try {
                // Try to load jsPDF from CDN
                const mod = await import('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.es.min.js');
                const { jsPDF } = mod;
                const doc = new jsPDF();
                doc.setFontSize(14);
                doc.text('Relatório de Verificações', 14, 20);
                doc.setFontSize(10);
                let y = 30;
                for (const it of completedItems.slice(0, 100)) {
                    const details = it.lotes ? `lotes:${it.lotes.length}` : `pc:${it.quantityPc}|stock:${it.quantityStock}`;
                    doc.text(`${it.date} - ${it.reference} - ${details}`, 14, y);
                    y += 7;
                    if (y > 270) { doc.addPage(); y = 20; }
                }
                if (pendingItems.length > 0) {
                    y += 6;
                    doc.text('Pendentes:', 14, y); y += 6;
                    for (const it of pendingItems.slice(0, 100)) {
                        const details = it.lotes ? `lotes:${it.lotes.length}` : `pc:${it.quantityPc}|stock:${it.quantityStock}`;
                        doc.text(`${it.date} - ${it.reference} - ${details}`, 14, y);
                        y += 7;
                        if (y > 270) { doc.addPage(); y = 20; }
                    }
                }
                const blob = doc.output('blob');
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report-${new Date().toISOString().slice(0,10)}.pdf`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                showNotification('PDF gerado');
            } catch (err) {
                console.error('PDF export failed', err);
                showNotification('Erro a gerar PDF (biblioteca indisponível)');
            }
        }

        

        // Scanner implementation
        let _scannerStream = null;
        let _scannerInterval = null;
    let _scannerOrigin = null; // 'verify' when opened from verification modal
    let _zxingReader = null;

        async function startScanner() {
            const video = document.getElementById('scannerVideo');
            const message = document.getElementById('scannerMessage');
            message.textContent = 'A pedir permissão para a câmera...';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
                _scannerStream = stream;
                video.srcObject = stream;
                message.textContent = 'A procurar código...';

                // If BarcodeDetector is available, use it
                if ('BarcodeDetector' in window) {
                    const detector = new BarcodeDetector({ formats: ['qr_code', 'ean_13', 'code_128'] });
                    _scannerInterval = setInterval(async () => {
                        try {
                            const barcodes = await detector.detect(video);
                            if (barcodes && barcodes.length > 0) {
                                const code = barcodes[0].rawValue;
                                stopScanner();
                                showNotification('Código detectado: ' + code);
                                // Extract a tolerant reference from scanned text
                                const extracted = extractRefFromScanned(code) || (code || '').toUpperCase();
                                itemReference.value = extracted;
                                itemReference.dispatchEvent(new Event('input'));
                                // If scanner was opened from verification modal, attempt to auto-fill lotes
                                if (_scannerOrigin === 'verify') {
                                    const matches = findSavedLotes(extracted);
                                    if (matches && matches.length > 0) {
                                        if (matches.length === 1) {
                                            populateLotesFromArray(matches[0].item.lotes);
                                        } else {
                                            openChooserModal(matches);
                                        }
                                    }
                                }
                                _scannerOrigin = null;
                                scannerModal.style.display = 'none';
                            }
                        } catch (err) {
                            console.error('detector error', err);
                        }
                    }, 500);
                } else {
                    // Fallback: try to lazy-load ZXing-js (@zxing/browser) for broader support
                    message.textContent = 'A carregar fallback do scanner...';
                    try {
                        // Dynamic import from unpkg (ESM). If this fails, inform the user.
                        const mod = await import('https://unpkg.com/@zxing/browser@0.0.12/esm/index.js');
                        const { BrowserMultiFormatReader } = mod;
                        _zxingReader = new BrowserMultiFormatReader();
                        // Use decodeFromVideoDevice to continuously scan
                        _zxingReader.decodeFromVideoDevice(null, video, (result, err) => {
                            if (result) {
                                    const code = result.getText();
                                    // Stop reader and stream
                                    try { _zxingReader.reset(); } catch (e) {}
                                    stopScanner();
                                    showNotification('Código detectado: ' + code);
                                    const extracted = extractRefFromScanned(code) || (code || '').toUpperCase();
                                    itemReference.value = extracted;
                                    itemReference.dispatchEvent(new Event('input'));
                                    if (_scannerOrigin === 'verify') {
                                        const matches = findSavedLotes(extracted);
                                        if (matches && matches.length > 0) {
                                            if (matches.length === 1) populateLotesFromArray(matches[0].item.lotes);
                                            else openChooserModal(matches);
                                        }
                                    }
                                    _scannerOrigin = null;
                                    scannerModal.style.display = 'none';
                                }
                            if (err && !(err.name && err.name === 'NotFoundException')) {
                                // ignore not found exceptions which are normal while scanning
                                console.error('ZXing error', err);
                            }
                        });
                    } catch (err) {
                        console.error('ZXing fallback failed', err);
                        message.textContent = 'Scanner não disponível neste browser.';
                    }
                }
            } catch (err) {
                console.error(err);
                message.textContent = 'Não foi possível aceder à câmera.';
            }
        }

        function stopScanner() {
            if (_scannerInterval) { clearInterval(_scannerInterval); _scannerInterval = null; }
            if (_zxingReader) {
                try { _zxingReader.reset(); } catch (err) { console.warn(err); }
                _zxingReader = null;
            }
            if (_scannerStream) {
                _scannerStream.getTracks().forEach(t => t.stop());
                _scannerStream = null;
            }
            const video = document.getElementById('scannerVideo');
            if (video) video.srcObject = null;
            const scannerModalEl = document.getElementById('scannerModal');
            if (scannerModalEl) scannerModalEl.style.display = 'none';
        }

        // Wire stop button
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'stopScannerBtn') stopScanner();
            if (e.target && e.target.id === 'openScannerFromVerifyBtn') {
                // open scanner modal and mark origin
                _scannerOrigin = 'verify';
                document.getElementById('scannerModal').style.display = 'flex';
                startScanner();
            }
        });
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg => console.log('Service Worker registado:', reg))
                .catch(err => console.log('Erro no SW:', err));
            });
        }
    </script>
</body>
</html>
